//devin87@qq.com
//build:2018/07/24 15:47:37
!function(e,t){"use strict";var i=Q.def,r=Q.fire,a=Q.extend,n=Q.getFirst,s=Q.getLast,o=JSON.parse,u=Q.createEle,l=Q.parseHTML,d=Q.setOpacity,c=Q.getOffset,p=Q.md5File,f=Q.event,h=f.add,m=f.trigger,v=f.stop,g=!1,_=!1,y=!1,w=0,T=0,k=0,S=0,x=1,I=2,b=-1,z=-2,E=-3;function L(e,t){var i=e.lastIndexOf(t);return-1!=i?e.slice(i):""}function M(e){if(e){for(var t=e.split(","),i={},r=0,a=t.length;r<a;r++)i[t[r]]=!0;return i}}function C(e){var t=this,i=e||{};t.guid=i.guid||"uploader"+ ++w,t.list=[],t.map={},t.index=0,t.started=!1,t.set(i)._init()}C.prototype={constructor:C,set:function(e){var r=this,n=a(e,r.ops);r.url=n.url,r.dataType=n.dataType||"json",r.data=n.data,r.targets=n.target||[],r.targets.forEach||(r.targets=[r.targets]),r.target=r.targets[0],r.html5=g&&!!i(n.html5,!0),r.multiple=_&&r.html5&&!!i(n.multiple,!0),r.clickTrigger=y&&!!i(n.clickTrigger,!0),r.workerThread=r.html5&&n.workerThread||1,r.workerIdle=r.workerThread,r.auto=!1!==n.auto,r.upName=n.upName||"upfile",r.accept=n.accept||n.allows,r.isDir=n.isDir,r.allows=M(n.allows),r.disallows=M(n.disallows),r.maxSize=+n.maxSize||0,r.isSlice=!!n.isSlice,r.chunkSize=+n.chunkSize||2097152,r.isQueryState=!!i(n.isQueryState,r.isSlice),r.isMd5=!!i(n.isMd5,r.isSlice),r.isUploadAfterHash=!1!==n.isUploadAfterHash,r.sliceRetryCount=n.sliceRetryCount==t?2:+n.sliceRetryCount||0,r.container=n.container||document.body,n.getPos&&(r.getPos=n.getPos);var s=n.UI||{};return s.init&&(r.init=s.init),s.draw&&(r.draw=s.draw),s.update&&(r.update=s.update),s.over&&(r.over=s.over),r.fns=n.on||{},r.ops=n,r.accept&&!r.clickTrigger&&r.resetInput(),r},_init:function(){var e=this;if(!e._inited){e._inited=!0;var i,r,a=e.guid,o=e.container,l=u("div","upload-input "+a);if(o.appendChild(l),e.boxInput=l,!e.html5){var c="upload_iframe_"+a,p=u("div","upload-html4 "+a,'<iframe class="u-iframe" name="'+c+'"></iframe><form class="u-form" action="" method="post" enctype="multipart/form-data" target="'+c+'"></form>');o.appendChild(p);var f=n(p),g=s(p);e.iframe=f,e.form=g,r=function(){if(0==e.workerIdle){var i;try{i=f.contentWindow.document.body.innerHTML}catch(e){}e.complete(t,I,i)}},(i=f).attachEvent?i.attachEvent("onload",r):i.addEventListener("load",r,!1)}return e.targets.forEach(function(t){e.clickTrigger?h(t,"click",function(t){!1!==e.fire("select",t)&&(e.resetInput(),m(e.inputFile,"click"))}):h(t,"mouseover",function(t){e.target=this,e.updatePos()})}),e.clickTrigger||(h(l,"click",function(t){!1===e.fire("select",t)&&v(t)}),d(l,0),e.resetInput()),e.fire("init"),e.run("init")}},resetInput:function(){var e=this,t=e.boxInput;if(!t)return e;t.innerHTML='<input type="file" name="'+e.upName+'"'+(e.accept?'accept="'+e.accept+'"':"")+(e.isDir?'webkitdirectory=""':"")+' style="'+(e.clickTrigger?"visibility: hidden;":"font-size:100px;")+'"'+(e.multiple?' multiple="multiple"':"")+">";var i=n(t);return h(i,"change",function(t){e.add(this),e.html5||e.resetInput()}),e.inputFile=i,e.updatePos()},updatePos:function(e){var t=this;if(t.clickTrigger)return t;var i=t.getPos||c,r=t.boxInput,a=n(r),s=t.target,o=s.offsetWidth,u=s.offsetHeight,l=0==o?{left:-1e4,top:-1e4}:i(s);return r.style.width=a.style.width=o+"px",r.style.height=a.style.height=u+"px",r.style.left=l.left+"px",r.style.top=l.top+"px",e&&(r.style.zIndex=++k),t},fire:function(e,t,i){if(!i)return r(this.fns[e],this,t);var a=this.fns[e+"Async"];if(a)return r(a,this,t,i);i(r(this.fns[e],this,t))},run:function(e,t){var i=this[e];return i&&r(i,this,t),this},addTask:function(e,t){if(e||t){var i,r;t?(i=t.webkitRelativePath||t.name||t.fileName,r=0===t.size?0:t.size||t.fileSize):(i=L(e.value,"\\").slice(1)||e.value,r=-1);var a,n=this,s=L(i,".").toLowerCase();n.disallows&&n.disallows[s]||n.allows&&!n.allows[s]?a="ext":-1!=r&&n.maxSize&&r>n.maxSize&&(a="size");var o={id:++T,name:i,ext:s,size:r,input:e,file:t,state:a?b:S};return a&&(o.limited=a,o.disabled=!0),n.fire("add",o,function(e){!1===e||o.disabled||o.limited||(o.index=n.list.length,n.list.push(o),n.map[o.id]=o,n.run("draw",o),n.auto&&n.start())}),o}},add:function(e){if("INPUT"==e.tagName){var i=e.files;if(i)for(var r=0,a=i.length;r<a;r++)this.addTask(e,i[r]);else this.addTask(e)}else this.addTask(t,e)},addList:function(e){for(var t=0,i=e.length;t<i;t++)this.add(e[t])},get:function(e){if(e!=t)return this.map[e]},cancel:function(e,t){var i=this,r=i.get(e);if(r){var a=r.state;if(a!=S&&a!=x)return i;if(a==x){var n=r.xhr;if(n)return n.abort(),i;i.iframe.contentWindow.location="about:blank"}return t?i:i.complete(r,z)}},remove:function(e){var t=this.get(e);t&&(t.state==x&&this.cancel(e),t.deleted=!0,this.fire("remove",t))},start:function(){var e=this,t=e.workerIdle,i=e.list,r=e.index,a=i.length;if(e.started||(e.started=!0),a<=0||r>=a||t<=0)return e;var n=i[r];return e.index++,e.upload(n)},upload:function(e){var t=this;return!e||e.state!=S||e.skip||e.deleted?t.start():(e.url=t.url,t.workerIdle--,t.fire("upload",e,function(i){if(!1===i)return t.complete(e,b);t.html5&&e.file?t._upload_html5_ready(e):e.input?t._upload_html4(e):t.complete(e,b)}),t)},queryState:function(e,t){var i=this,a=i.url,n=new XMLHttpRequest;return e.queryUrl=a+(-1==a.indexOf("?")?"?":"&")+"action=query&hash="+(e.hash||encodeURIComponent(e.name))+"&fileName="+encodeURIComponent(e.name)+(-1!=e.size?"&fileSize="+e.size:""),i.fire("sliceQuery",e),n.open("GET",e.queryUrl),n.onreadystatechange=function(){if(4==n.readyState){var a,s;if(n.status>=200&&n.status<400)if("ok"===(a=n.responseText)?s={ret:1}:a&&(s=o(a)),s&&"number"!=typeof s||(s={ret:0,start:s}),e.response=a,e.json=s,1==s.ret)e.queryOK=!0,i.cancel(e.id,!0).complete(e,I);else{var u=+s.start||0;u!=Math.floor(u)&&(u=0),e.sliceStart=u}r(t,i,n)}},n.onerror=function(){r(t,i,n)},n.send(null),i},_upload_html5_ready:function(e){var t=this,i=function(){e.state!=I&&(t.isSlice?t._upload_slice(e):t._upload_html5(e))},a=function(i){t.fire("hash",e,function(){e.hash&&t.isQueryState&&e.state!=I?t.queryState(e,i):i()})},n=function(i){if(t.isMd5&&p){var n=t.fns.hashProgress;p(e.file,function(t,r){e.hash=t,e.timeHash=r,a(i)},function(i){r(n,t,e,i)})}else a(i)};return t.isUploadAfterHash?n(i):(i(),n()),t},_process_params:function(e,t){this.data&&Object.forEach(this.data,t),e.data&&Object.forEach(e.data,t)},_upload_html5:function(e){var t=this,i=new XMLHttpRequest;e.xhr=i,i.upload.addEventListener("progress",function(i){t.progress(e,i.total,i.loaded)},!1),i.addEventListener("load",function(i){t.complete(e,I,i.target.responseText)},!1),i.addEventListener("error",function(){t.complete(e,E)},!1),i.addEventListener("abort",function(){t.complete(e,z)},!1);var r=new FormData;t._process_params(e,function(e,t){r.append(e,t)}),r.append("fileName",e.name),r.append(t.upName,e.blob||e.file,e.name),i.open("POST",e.url),t.fire("send",e,function(a){if(!1===a)return t.complete(e,b);i.send(r),t._afterSend(e)})},_upload_html4:function(e){var t=this,i=t.form,r=e.input;if(r._uploaded)return t.complete(e,I);r._uploaded=!0,r.name=t.upName,i.innerHTML="",i.appendChild(r),i.action=e.url,t._process_params(e,function(e,t){i.appendChild(l('<input type="hidden" name="'+e+'" value="'+t+'">'))}),t.fire("send",e,function(r){if(!1===r)return t.complete(e,b);i.submit(),t._afterSend(e)})},_afterSend:function(e){e.lastTime=e.startTime=Date.now(),e.state=x,this._lastTask=e,this.progress(e)},progress:function(e,t,i){t||(t=e.size),(!i||i<0)&&(i=0);var r=e.state||S;i>t&&(i=t),i>0&&r==S&&(e.state=r=x),r==I&&(t=i=e.size),function(e,t,i){if(t&&!(t<=0)){var r,a=Date.now();if(i>=t)return(r=a-e.startTime)?e.avgSpeed=Math.min(Math.round(1e3*t/r),t):e.speed||(e.avgSpeed=e.speed=t),e.time=r||0,void(e.endTime=a);(r=a-e.lastTime)<200||(e.speed=Math.min(Math.round(1e3*(i-e.loaded)/r),e.total),e.lastTime=a)}}(e,t,i),e.total=t,e.loaded=i,this.fire("progress",e),this.run("update",e)},_process_response:function(e,t){e.response=t,t&&"json"==this.dataType&&(e.json=o(t))},complete:function(e,i,r){var a=this;return e||1!=a.workerThread||(e=a._lastTask),e&&(i!=t&&(e.state=i),e.state!=x&&i!=I||(e.state=I,a.progress(e,e.size,e.size)),r!==t&&a._process_response(e,r)),a.run("update",e).run("over",e),i==z&&a.fire("cancel",e),a.fire("complete",e),a.workerIdle++,a.started&&a.start(),a}},C.extend=function(e,t){a(C.prototype,e,t)},function(){var t=e.XMLHttpRequest;t&&(new t).upload&&e.FormData&&(g=!0);var i=document.createElement("input");i.type="file",_=!!i.files,y=g}(),a(C,{support:{html5:g,multiple:_},READY:S,PROCESSING:x,COMPLETE:I,SKIP:b,CANCEL:z,ERROR:E,UI:{},Lang:{status_ready:"准备中",status_processing:"上传中",status_complete:"已完成",status_skip:"已跳过",status_cancel:"已取消",status_error:"已失败"},getStatusText:function(e){var t=C.Lang;switch(e){case S:return t.status_ready;case x:return t.status_processing;case I:return t.status_complete;case b:return t.status_skip;case z:return t.status_cancel;case E:return t.status_error}return e}}),Q.Uploader=C}(window);