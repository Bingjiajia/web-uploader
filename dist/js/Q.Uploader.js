//devin87@qq.com
//build:2016/06/17 13:31:24
!function(e,t){"use strict";function i(e){switch(e){case N:return"准备中";case R:return"上传中";case H:return"已完成";case P:return"已跳过";case z:return"已取消";case O:return"已失败"}return e}function r(){var t=e.XMLHttpRequest;t&&(new t).upload&&e.FormData&&(x=!0);var i=document.createElement("input");i.type="file",L=!!i.files,E=x}function a(e,t){var i=e.lastIndexOf(t);return-1!=i?e.slice(i):""}function n(e){if(e){for(var t=e.split(","),i={},r=0,a=t.length;a>r;r++)i[t[r]]=!0;return i}}function s(e,t){e.attachEvent?e.attachEvent("onload",t):e.addEventListener("load",t,!1)}function o(e,t,i){if(t&&!(0>=t)){var r,a=Date.now();if(i>=t)return r=a-e.startTime,r?e.avgSpeed=Math.min(Math.round(1e3*t/r),t):e.speed||(e.avgSpeed=e.speed=t),e.time=r||0,void(e.endTime=a);r=a-e.lastTime,200>r||(e.speed=Math.min(Math.round(1e3*(i-e.loaded)/r),e.total),e.lastTime=a)}}function u(e){var t=this;t.guid=e.guid||"uploader"+ ++I,t.url=e.url,t.dataType=e.dataType||"json",t.data=e.data,t.target=e.target,t.html5=x&&!!l(e.html5,!0),t.multiple=L&&t.html5&&!!l(e.multiple,!0),t.clickTrigger=E&&!!l(e.clickTrigger,!0),t.workerThread=t.html5?e.workerThread||1:1,t.workerIdle=t.workerThread,t.auto=e.auto!==!1,t.upName=e.upName||"upfile",t.allows=n(e.allows),t.disallows=n(e.disallows),t.chunkSize=e.chunkSize||2097152,t.isSlice=!!e.isSlice,t.isQueryState=!!l(e.isQueryState,t.isSlice),t.isMd5=!!l(e.isMd5,t.isSlice),t.container=e.container||document.body,e.getPos&&(t.getPos=e.getPos);var i=e.UI||{};i.init&&(t.init=i.init),i.draw&&(t.draw=i.draw),i.update&&(t.update=i.update),i.over&&(t.over=i.over),t.fns=e.on||{},t.ops=e,t.list=[],t.map={},t.index=0,t.started=!1,t._init()}var l=Q.def,d=Q.fire,p=Q.extend,c=Q.getFirst,f=Q.getLast,h=JSON.parse,m=Q.createEle,v=Q.parseHTML,g=Q.setOpacity,_=Q.getOffset,w=Q.md5File,T=Q.event,y=T.add,k=T.trigger,S=T.stop,x=!1,L=!1,E=!1,I=0,M=0,b=0,N=0,R=1,H=2,P=-1,z=-2,O=-3;u.prototype={constructor:u,_init:function(){var e=this;if(!e._inited){e._inited=!0;var i=e.guid,r=e.target,a=e.container,n=m("div","upload-input "+i);if(a.appendChild(n),e.boxInput=n,!e.html5){var o="upload_iframe_"+i,u='<iframe class="u-iframe" name="'+o+'"></iframe><form class="u-form" action="" method="post" enctype="multipart/form-data" target="'+o+'"></form>',l=m("div","upload-html4 "+i,u);a.appendChild(l);var d=c(l),p=f(l);e.iframe=d,e.form=p,s(d,function(){if(0==e.workerIdle){var i;try{i=d.contentWindow.document.body.innerHTML}catch(r){}e.complete(t,H,i)}})}return e.clickTrigger?y(r,"click",function(t){e.fire("select",t)!==!1&&(e.resetInput(),k(e.inputFile,"click"))}):(y(n,"click",function(t){e.fire("select",t)===!1&&S(t)}),g(n,0),e.resetInput()),e.fire("init"),e.run("init")}},resetInput:function(){var e=this,t=e.boxInput;t.innerHTML='<input type="file" name="'+e.upName+'" style="'+(e.clickTrigger?"visibility: hidden;":"font-size:100px;")+'"'+(e.multiple?' multiple="multiple"':"")+">";var i=c(t);return y(i,"change",function(t){e.add(this),e.html5||e.resetInput()}),e.inputFile=i,e.updatePos()},updatePos:function(e){var t=this;if(t.clickTrigger)return t;var i=t.getPos||_,r=t.boxInput,a=c(r),n=t.target,s=n.offsetWidth,o=n.offsetHeight,u=0==s?{left:-1e4,top:-1e4}:i(n);return r.style.width=a.style.width=s+"px",r.style.height=a.style.height=o+"px",r.style.left=u.left+"px",r.style.top=u.top+"px",e&&(r.style.zIndex=++b),t},fire:function(e,t,i){if(!i)return d(this.fns[e],this,t);var r=this.fns[e+"Async"];return r?d(r,this,t,i):void i(d(this.fns[e],this,t))},run:function(e,t){var i=this[e];return i&&d(i,this,t),this},addTask:function(e,t){if(e||t){var i,r;t?(i=t.name||t.fileName,r=t.size||t.fileSize):(i=a(e.value,"\\").slice(1)||e.value,r=-1);var n=this,s=a(i,".").toLowerCase(),o=n.disallows&&n.disallows[s]||n.allows&&!n.allows[s],u={id:++M,name:i,ext:s,size:r,input:e,file:t,state:o?P:N};return o&&(u.disabled=!0),n.fire("add",u,function(e){e===!1||u.disabled||(u.index=n.list.length,n.list.push(u),n.map[u.id]=u,n.run("draw",u),n.auto&&n.start())}),u}},add:function(e){var i=this;if("INPUT"==e.tagName){var r=e.files;if(r)for(var a=0,n=r.length;n>a;a++)i.addTask(e,r[a]);else i.addTask(e)}else i.addTask(t,e)},addList:function(e){for(var t=0,i=e.length;i>t;t++)this.add(e[t])},get:function(e){return e!=t?this.map[e]:void 0},cancel:function(e){var t=this,i=t.get(e);if(i){var r=i.state;if(r!=N&&r!=R)return t;if(r==R){var a=i.xhr;if(a)return a.abort(),t;t.iframe.contentWindow.location="about:blank"}return t.complete(i,z)}},remove:function(e){var t=this.get(e);t&&(t.state==R&&this.cancel(e),t.deleted=!0,this.fire("remove",t))},start:function(){var e=this,t=e.workerIdle,i=e.list,r=e.index,a=i.length;if(e.started||(e.started=!0),0>=a||r>=a||0>=t)return e;var n=i[r];return e.index++,e.upload(n)},upload:function(e){var t=this;return!e||e.state!=N||e.skip?t.start():(e.url=t.url,t.workerIdle--,t.fire("upload",e,function(i){return i===!1?t.complete(e,P):void(t.html5&&e.file?t._upload_html5_ready(e):e.input?t._upload_html4(e):t.complete(e,P))}),t)},_upload_html5_ready:function(e){var t=this,i=function(i){var r=t.url,a=new XMLHttpRequest;r+=(-1==r.indexOf("?")?"?":"&")+"action=query&hash="+e.hash,a.open("GET",r),a.setRequestHeader("X-Requested-With","XMLHttpRequest"),a.onreadystatechange=function(){if(4==a.readyState){if(a.status>=200&&a.status<400){var r=a.responseText;if("ok"===r)return t.complete(e,H);var n=!r||isNaN(r)?0:+r;n!=Math.floor(n)&&(n=0),e.sliceStart=n}i()}},a.onerror=function(){i()},a.send(null)},r=function(){t.isSlice?t._upload_slice(e):t._upload_html5(e)},a=function(){t.fire("hash",e,function(){e.hash&&t.isQueryState?i(r):r()})};if(t.isMd5&&w){var n=t.fns.hashProgress;w(e.file,function(t,i){e.hash=t,e.timeHash=i,a()},function(i){d(n,t,e,i)})}else a()},_process_params:function(e,t){this.data&&Object.forEach(this.data,t),e.data&&Object.forEach(e.data,t)},_upload_html5:function(e){var t=this,i=new XMLHttpRequest;e.xhr=i,i.upload.addEventListener("progress",function(i){t.progress(e,i.total,i.loaded)},!1),i.addEventListener("load",function(i){t.complete(e,H,i.target.responseText)},!1),i.addEventListener("error",function(){t.complete(e,O)},!1),i.addEventListener("abort",function(){t.complete(e,z)},!1);var r=new FormData;t._process_params(e,function(e,t){r.append(e,t)}),r.append("fileName",e.name),r.append(t.upName,e.blob||e.file,e.name),i.open("POST",e.url),i.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.fire("send",e,function(a){return a===!1?t.complete(e,P):(i.send(r),void t._afterSend(e))})},_upload_html4:function(e){var t=this,i=t.form,r=e.input;return r._uploaded?t.complete(e,H):(r._uploaded=!0,r.name=t.upName,i.innerHTML="",i.appendChild(r),i.action=e.url,t._process_params(e,function(e,t){i.appendChild(v('<input type="hidden" name="'+e+'" value="'+t+'">'))}),void t.fire("send",e,function(r){return r===!1?t.complete(e,P):(i.submit(),void t._afterSend(e))}))},_afterSend:function(e){e.lastTime=e.startTime=Date.now(),e.state=R,this._lastTask=e,this.progress(e)},progress:function(e,t,i){t||(t=e.size),(!i||0>i)&&(i=0);var r=e.state||N;i>t&&(i=t),i>0&&r==N&&(e.state=r=R);var a=r==H;a&&(t=i=e.size),o(e,t,i),e.total=t,e.loaded=i,this.fire("progress",e),this.run("update",e)},_process_response:function(e,t){e.response=t,t&&"json"==this.dataType&&(e.json=h(t))},complete:function(e,i,r){var a=this;return e||1!=a.workerThread||(e=a._lastTask),e&&(i!=t&&(e.state=i),e.state!=R&&i!=H||(e.state=H,a.progress(e,e.size,e.size)),r!==t&&a._process_response(e,r)),i==z&&a.fire("cancel",e),a.fire("complete",e),a.run("over",e).run("update",e),a.workerIdle++,a.started&&a.start(),a}},u.extend=function(e,t){p(u.prototype,e,t)},r(),p(u,{support:{html5:x,multiple:L},READY:N,PROCESSING:R,COMPLETE:H,SKIP:P,CANCEL:z,ERROR:O,getStatusText:i}),Q.Uploader=u}(window);