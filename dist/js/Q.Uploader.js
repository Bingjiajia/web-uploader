//devin87@qq.com
//build:2017/08/28 13:50:44
!function(e,t){"use strict";function r(e){var t=u.Lang;switch(e){case N:return t.status_ready;case H:return t.status_processing;case O:return t.status_complete;case P:return t.status_skip;case z:return t.status_cancel;case C:return t.status_error}return e}function a(){var t=e.XMLHttpRequest;t&&(new t).upload&&e.FormData&&(x=!0);var r=document.createElement("input");r.type="file",I=!!r.files,L=x}function i(e,t){var r=e.lastIndexOf(t);return-1!=r?e.slice(r):""}function n(e){if(e){for(var t=e.split(","),r={},a=0,i=t.length;i>a;a++)r[t[a]]=!0;return r}}function s(e,t){e.attachEvent?e.attachEvent("onload",t):e.addEventListener("load",t,!1)}function o(e,t,r){if(t&&!(0>=t)){var a,i=Date.now();if(r>=t)return a=i-e.startTime,a?e.avgSpeed=Math.min(Math.round(1e3*t/a),t):e.speed||(e.avgSpeed=e.speed=t),e.time=a||0,void(e.endTime=i);a=i-e.lastTime,200>a||(e.speed=Math.min(Math.round(1e3*(r-e.loaded)/a),e.total),e.lastTime=i)}}function u(e){var t=this;t.guid=e.guid||"uploader"+ ++b,t.url=e.url,t.dataType=e.dataType||"json",t.data=e.data,t.target=e.target,t.html5=x&&!!l(e.html5,!0),t.multiple=I&&t.html5&&!!l(e.multiple,!0),t.clickTrigger=L&&!!l(e.clickTrigger,!0),t.workerThread=t.html5?e.workerThread||1:1,t.workerIdle=t.workerThread,t.auto=e.auto!==!1,t.upName=e.upName||"upfile",t.allows=n(e.allows),t.disallows=n(e.disallows),t.chunkSize=e.chunkSize||2097152,t.isSlice=!!e.isSlice,t.isQueryState=!!l(e.isQueryState,t.isSlice),t.isMd5=!!l(e.isMd5,t.isSlice),t.isUploadAfterHash=e.isUploadAfterHash!==!1,t.container=e.container||document.body,e.getPos&&(t.getPos=e.getPos);var r=e.UI||{};r.init&&(t.init=r.init),r.draw&&(t.draw=r.draw),r.update&&(t.update=r.update),r.over&&(t.over=r.over),t.fns=e.on||{},t.ops=e,t.list=[],t.map={},t.index=0,t.started=!1,t._init()}var l=Q.def,d=Q.fire,c=Q.extend,p=Q.getFirst,f=Q.getLast,h=JSON.parse,m=Q.createEle,v=Q.parseHTML,g=Q.setOpacity,_=Q.getOffset,y=Q.md5File,w=Q.event,T=w.add,k=w.trigger,S=w.stop,x=!1,I=!1,L=!1,b=0,E=0,M=0,N=0,H=1,O=2,P=-1,z=-2,C=-3;u.prototype={constructor:u,_init:function(){var e=this;if(!e._inited){e._inited=!0;var r=e.guid,a=e.target,i=e.container,n=m("div","upload-input "+r);if(i.appendChild(n),e.boxInput=n,!e.html5){var o="upload_iframe_"+r,u='<iframe class="u-iframe" name="'+o+'"></iframe><form class="u-form" action="" method="post" enctype="multipart/form-data" target="'+o+'"></form>',l=m("div","upload-html4 "+r,u);i.appendChild(l);var d=p(l),c=f(l);e.iframe=d,e.form=c,s(d,function(){if(0==e.workerIdle){var r;try{r=d.contentWindow.document.body.innerHTML}catch(a){}e.complete(t,O,r)}})}return e.clickTrigger?T(a,"click",function(t){e.fire("select",t)!==!1&&(e.resetInput(),k(e.inputFile,"click"))}):(T(n,"click",function(t){e.fire("select",t)===!1&&S(t)}),g(n,0),e.resetInput()),e.fire("init"),e.run("init")}},resetInput:function(){var e=this,t=e.boxInput;t.innerHTML='<input type="file" name="'+e.upName+'" style="'+(e.clickTrigger?"visibility: hidden;":"font-size:100px;")+'"'+(e.multiple?' multiple="multiple"':"")+">";var r=p(t);return T(r,"change",function(t){e.add(this),e.html5||e.resetInput()}),e.inputFile=r,e.updatePos()},updatePos:function(e){var t=this;if(t.clickTrigger)return t;var r=t.getPos||_,a=t.boxInput,i=p(a),n=t.target,s=n.offsetWidth,o=n.offsetHeight,u=0==s?{left:-1e4,top:-1e4}:r(n);return a.style.width=i.style.width=s+"px",a.style.height=i.style.height=o+"px",a.style.left=u.left+"px",a.style.top=u.top+"px",e&&(a.style.zIndex=++M),t},fire:function(e,t,r){if(!r)return d(this.fns[e],this,t);var a=this.fns[e+"Async"];return a?d(a,this,t,r):void r(d(this.fns[e],this,t))},run:function(e,t){var r=this[e];return r&&d(r,this,t),this},addTask:function(e,t){if(e||t){var r,a;t?(r=t.name||t.fileName,a=t.size||t.fileSize):(r=i(e.value,"\\").slice(1)||e.value,a=-1);var n=this,s=i(r,".").toLowerCase(),o=n.disallows&&n.disallows[s]||n.allows&&!n.allows[s],u={id:++E,name:r,ext:s,size:a,input:e,file:t,state:o?P:N};return o&&(u.disabled=!0),n.fire("add",u,function(e){e===!1||u.disabled||(u.index=n.list.length,n.list.push(u),n.map[u.id]=u,n.run("draw",u),n.auto&&n.start())}),u}},add:function(e){var r=this;if("INPUT"==e.tagName){var a=e.files;if(a)for(var i=0,n=a.length;n>i;i++)r.addTask(e,a[i]);else r.addTask(e)}else r.addTask(t,e)},addList:function(e){for(var t=0,r=e.length;r>t;t++)this.add(e[t])},get:function(e){return e!=t?this.map[e]:void 0},cancel:function(e,t){var r=this,a=r.get(e);if(a){var i=a.state;if(i!=N&&i!=H)return r;if(i==H){var n=a.xhr;if(n)return n.abort(),r;r.iframe.contentWindow.location="about:blank"}return t?r:r.complete(a,z)}},remove:function(e){var t=this.get(e);t&&(t.state==H&&this.cancel(e),t.deleted=!0,this.fire("remove",t))},start:function(){var e=this,t=e.workerIdle,r=e.list,a=e.index,i=r.length;if(e.started||(e.started=!0),0>=i||a>=i||0>=t)return e;var n=r[a];return e.index++,e.upload(n)},upload:function(e){var t=this;return!e||e.state!=N||e.skip?t.start():(e.url=t.url,t.workerIdle--,t.fire("upload",e,function(r){return r===!1?t.complete(e,P):void(t.html5&&e.file?t._upload_html5_ready(e):e.input?t._upload_html4(e):t.complete(e,P))}),t)},queryState:function(e,t){var r=this,a=r.url,i=new XMLHttpRequest;return e.queryUrl=a+(-1==a.indexOf("?")?"?":"&")+"action=query&hash="+(e.hash||encodeURIComponent(e.name))+"&fileName="+encodeURIComponent(e.name),r.fire("sliceQuery",e),i.open("GET",e.queryUrl),i.onreadystatechange=function(){if(4==i.readyState){var a,n;if(i.status>=200&&i.status<400)if(a=i.responseText,"ok"===a?n={ret:1}:a&&(n=h(a)),n&&"number"!=typeof n||(n={ret:0,start:n}),e.response=a,e.json=n,1==n.ret)e.queryOK=!0,r.cancel(e.id,!0).complete(e,O);else{var s=+n.start||0;s!=Math.floor(s)&&(s=0),e.sliceStart=s}d(t,r,i)}},i.onerror=function(){d(t,r,i)},i.send(null),r},_upload_html5_ready:function(e){var t=this,r=function(){e.state!=O&&(t.isSlice?t._upload_slice(e):t._upload_html5(e))},a=function(r){t.fire("hash",e,function(){e.hash&&t.isQueryState&&e.state!=O?t.queryState(e,r):r()})},i=function(r){if(t.isMd5&&y){var i=t.fns.hashProgress;y(e.file,function(t,i){e.hash=t,e.timeHash=i,a(r)},function(r){d(i,t,e,r)})}else a(r)};return t.isUploadAfterHash?i(r):(r(),i()),t},_process_params:function(e,t){this.data&&Object.forEach(this.data,t),e.data&&Object.forEach(e.data,t)},_upload_html5:function(e){var t=this,r=new XMLHttpRequest;e.xhr=r,r.upload.addEventListener("progress",function(r){t.progress(e,r.total,r.loaded)},!1),r.addEventListener("load",function(r){t.complete(e,O,r.target.responseText)},!1),r.addEventListener("error",function(){t.complete(e,C)},!1),r.addEventListener("abort",function(){t.complete(e,z)},!1);var a=new FormData;t._process_params(e,function(e,t){a.append(e,t)}),a.append("fileName",e.name),a.append(t.upName,e.blob||e.file,e.name),r.open("POST",e.url),t.fire("send",e,function(i){return i===!1?t.complete(e,P):(r.send(a),void t._afterSend(e))})},_upload_html4:function(e){var t=this,r=t.form,a=e.input;return a._uploaded?t.complete(e,O):(a._uploaded=!0,a.name=t.upName,r.innerHTML="",r.appendChild(a),r.action=e.url,t._process_params(e,function(e,t){r.appendChild(v('<input type="hidden" name="'+e+'" value="'+t+'">'))}),void t.fire("send",e,function(a){return a===!1?t.complete(e,P):(r.submit(),void t._afterSend(e))}))},_afterSend:function(e){e.lastTime=e.startTime=Date.now(),e.state=H,this._lastTask=e,this.progress(e)},progress:function(e,t,r){t||(t=e.size),(!r||0>r)&&(r=0);var a=e.state||N;r>t&&(r=t),r>0&&a==N&&(e.state=a=H);var i=a==O;i&&(t=r=e.size),o(e,t,r),e.total=t,e.loaded=r,this.fire("progress",e),this.run("update",e)},_process_response:function(e,t){e.response=t,t&&"json"==this.dataType&&(e.json=h(t))},complete:function(e,r,a){var i=this;return e||1!=i.workerThread||(e=i._lastTask),e&&(r!=t&&(e.state=r),e.state!=H&&r!=O||(e.state=O,i.progress(e,e.size,e.size)),a!==t&&i._process_response(e,a)),i.run("update",e).run("over",e),r==z&&i.fire("cancel",e),i.fire("complete",e),i.workerIdle++,i.started&&i.start(),i}},u.extend=function(e,t){c(u.prototype,e,t)},a(),c(u,{support:{html5:x,multiple:I},READY:N,PROCESSING:H,COMPLETE:O,SKIP:P,CANCEL:z,ERROR:C,UI:{},Lang:{status_ready:"准备中",status_processing:"上传中",status_complete:"已完成",status_skip:"已跳过",status_cancel:"已取消",status_error:"已失败"},getStatusText:r}),Q.Uploader=u}(window);