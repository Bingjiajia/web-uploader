//devin87@qq.com
//build:2016/04/22 14:58:44
!function(t,e){"use strict";function r(t){switch(t){case M:return"准备中";case N:return"上传中";case P:return"已完成";case O:return"已跳过";case R:return"已取消";case z:return"已失败"}return t}function i(){var e=t.XMLHttpRequest;e&&(new e).upload&&t.FormData&&(x=!0);var r=document.createElement("input");r.type="file",E=!!r.files,I=x}function a(t,e){var r=t.lastIndexOf(e);return-1!=r?t.slice(r):""}function n(t){if(t){for(var e=t.split(","),r={},i=0,a=e.length;a>i;i++)r[e[i]]=!0;return r}}function s(t,e){t.attachEvent?t.attachEvent("onload",e):t.addEventListener("load",e,!1)}function o(t,e,r){if(e&&!(0>=e)){var i,a=Date.now();if(r>=e)return i=a-t.timeStart,i&&(t.avgSpeed=Math.min(Math.round(1e3*e/i),e)),void(t.timeEnd=a);i=a-t.time,200>i||(t.speed=Math.min(Math.round(1e3*(r-t.loaded)/i),t.total),t.time=a)}}function d(t){var e=this;e.guid=t.guid||"uploader"+ ++b,e.url=t.url,e.dataType=t.dataType||"json",e.data=t.data,e.target=t.target,e.html5=x&&!!u(t.html5,!0),e.multiple=E&&e.html5&&!!u(t.multiple,!0),e.clickTrigger=I&&!!u(t.clickTrigger,!0),e.workerThread=e.html5?t.workerThread||1:1,e.workerIdle=e.workerThread,e.auto=t.auto!==!1,e.upName=t.upName||"upfile",e.allows=n(t.allows),e.disallows=n(t.disallows),e.container=t.container||document.body,t.getPos&&(e.getPos=t.getPos);var r=t.UI||{};r.init&&(e.init=r.init),r.draw&&(e.draw=r.draw),r.update&&(e.update=r.update),r.over&&(e.over=r.over),e.fns=t.on||{},e.ops=t,e.list=[],e.map={},e.index=0,e.started=!1,e._init()}var u=Q.def,l=Q.fire,p=Q.extend,c=Q.getFirst,f=Q.getLast,h=JSON.parse,m=Q.createEle,v=Q.parseHTML,g=Q.setOpacity,w=Q.getOffset,_=Q.event,T=_.add,k=_.trigger,y=_.stop,x=!1,E=!1,I=!1,b=0,L=0,S=0,M=0,N=1,P=2,O=-1,R=-2,z=-3;d.prototype={constructor:d,_init:function(){var t=this;if(!t._inited){t._inited=!0;var r=t.guid,i=t.target,a=t.container,n=m("div","upload-input "+r);if(a.appendChild(n),t.boxInput=n,!t.html5){var o="upload_iframe_"+r,d='<iframe class="u-iframe" name="'+o+'"></iframe><form class="u-form" action="" method="post" enctype="multipart/form-data" target="'+o+'"></form>',u=m("div","upload-html4 "+r,d);a.appendChild(u);var l=c(u),p=f(u);t.iframe=l,t.form=p,s(l,function(){if(0==t.workerIdle){var r;try{r=l.contentWindow.document.body.innerHTML}catch(i){}t.complete(e,P,r)}})}return t.clickTrigger?T(i,"click",function(e){t.fire("select",e)!==!1&&(t.resetInput(),k(t.inputFile,"click"))}):(T(n,"click",function(e){t.fire("select",e)===!1&&y(e)}),g(n,0),t.resetInput()),t.fire("init"),t.run("init")}},resetInput:function(){var t=this,e=t.boxInput;e.innerHTML='<input type="file" name="'+t.upName+'" style="'+(t.clickTrigger?"visibility: hidden;":"font-size:100px;")+'"'+(t.multiple?' multiple="multiple"':"")+">";var r=c(e);return T(r,"change",function(e){t.add(this),t.html5||t.resetInput()}),t.inputFile=r,t.updatePos()},updatePos:function(t){var e=this;if(e.clickTrigger)return e;var r=e.getPos||w,i=e.boxInput,a=c(i),n=e.target,s=n.offsetWidth,o=n.offsetHeight,d=0==s?{left:-1e4,top:-1e4}:r(n);return i.style.width=a.style.width=s+"px",i.style.height=a.style.height=o+"px",i.style.left=d.left+"px",i.style.top=d.top+"px",t&&(i.style.zIndex=++S),e},fire:function(t,e,r){if(!r)return l(this.fns[t],this,e);var i=this.fns[t+"Async"];return i?l(i,this,e,r):void r(l(this.fns[t],this,e))},run:function(t,e){var r=this[t];return r&&l(r,this,e),this},addTask:function(t,e,r){if(t||e){var i,n;e?(i=e.name||e.fileName,n=e.size||e.fileSize):(i=a(t.value,"\\").slice(1)||t.value,n=-1);var s=this,o=a(i,".").toLowerCase(),d=s.disallows&&s.disallows[o]||s.allows&&!s.allows[o],u={id:++L,name:i,ext:o,size:n,input:t,file:e,arg:r,state:d?O:M};return d&&(u.disabled=!0),s.fire("add",u,function(t){t===!1||u.disabled||(u.index=s.list.length,s.list.push(u),s.map[u.id]=u,s.run("draw",u),s.auto&&s.start())}),u}},add:function(t){var r=this;if("INPUT"==t.tagName){var i=t.files;if(i)for(var a=0,n=i.length;n>a;a++)r.addTask(t,i[a]);else r.addTask(t)}else r.addTask(e,t)},addList:function(t){for(var e=0,r=t.length;r>e;e++)this.add(t[e])},get:function(t){return t!=e?this.map[t]:void 0},cancel:function(t){var e=this,r=e.get(t);if(r){var i=r.state;if(i!=M&&i!=N)return e;if(i==N){var a=r.xhr;if(a)return a.abort(),e;e.iframe.contentWindow.location="about:blank"}return e.complete(r,R)}},remove:function(t){var e=this.get(t);e&&(e.state==N&&this.cancel(t),e.deleted=!0,this.fire("remove",e))},start:function(){var t=this,e=t.workerIdle,r=t.list,i=t.index,a=r.length;if(t.started||(t.started=!0),0>=a||i>=a||0>=e)return t;var n=r[i];return t.index++,t.upload(n)},upload:function(t){var e=this;return!t||t.state!=M||t.skip?e.start():(t.url=e.url,e.workerIdle--,e.fire("upload",t,function(r){return r===!1?e.complete(t,O):void(e.html5&&t.file?e._upload_html5(t):t.input?e._upload_html4(t):e.complete(t,O))}),e)},_process_params:function(t,e){this.data&&Object.forEach(this.data,e),t.data&&Object.forEach(t.data,e)},_upload_html5:function(t){var e=this,r=new XMLHttpRequest;t.xhr=r,r.upload.addEventListener("progress",function(r){e.progress(t,r.total,r.loaded)},!1),r.addEventListener("load",function(r){e.complete(t,P,r.target.responseText)},!1),r.addEventListener("error",function(){e.complete(t,z)},!1),r.addEventListener("abort",function(){e.complete(t,R)},!1);var i=new FormData;e._process_params(t,function(t,e){i.append(t,e)}),i.append("fileName",t.name),i.append(e.upName,t.blob||t.file,t.name),r.open("POST",t.url),r.setRequestHeader("X-Requested-With","XMLHttpRequest"),e.fire("send",t,function(a){return a===!1?e.complete(t,O):(r.send(i),void e._afterSend(t))})},_upload_html4:function(t){var e=this,r=e.form,i=t.input;return i._uploaded?e.complete(t,P):(i._uploaded=!0,i.name=e.upName,r.innerHTML="",r.appendChild(i),r.action=t.url,e._process_params(t,function(t,e){r.appendChild(v('<input type="hidden" name="'+t+'" value="'+e+'">'))}),void e.fire("send",t,function(i){return i===!1?e.complete(t,O):(r.submit(),void e._afterSend(t))}))},_afterSend:function(t){t.time=t.timeStart=Date.now(),t.state=N,this._lastTask=t,this.progress(t)},progress:function(t,e,r){e||(e=t.size),(!r||0>r)&&(r=0);var i=t.state||M;r>e&&(r=e),r>0&&i==M&&(t.state=i=N);var a=i==P;a&&(e=r=t.size),o(t,e,r),t.total=e,t.loaded=r,this.fire("progress",t),this.run("update",t)},_process_response:function(t,e){t.response=e,e&&"json"==this.dataType&&(t.json=h(e))},complete:function(t,r,i){var a=this;return t||1!=a.workerThread||(t=a._lastTask),t&&(r!=e&&(t.state=r),t.state==N&&(t.state=P,a.progress(t,t.size,t.size)),i!==e&&a._process_response(t,i)),r==R&&a.fire("cancel",t),a.fire("complete",t),a.run("over",t).run("update",t),a.workerIdle++,a.started&&a.start(),a}},d.extend=function(t,e){p(d.prototype,t,e)},i(),p(d,{support:{html5:x,multiple:E},READY:M,PROCESSING:N,COMPLETE:P,SKIP:O,CANCEL:R,ERROR:z,getStatusText:r}),Q.Uploader=d}(window);